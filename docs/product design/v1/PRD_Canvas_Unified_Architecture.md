# PRD: Canvas统一架构设计

| Document Info | Details |
| --- | --- |
| **Version** | v1.1 |
| **Status** | Design Phase |
| **Scope** | Canvas Architecture, Views, and Sections |
| **Feature Type** | Core Architecture Update |

---

## 1. 核心设计理念：视图为体，Section为用

为了解决Canvas节点混乱、布局逻辑冲突以及组织困难的问题，我们采用**"Section + Sidebar"**的分层治理策略：

1.  **Sidebar（宏观视图）**：负责切换**世界观**（交互规则）。解决"自由布局"与"自动布局"的冲突。
2.  **Section（微观组织）**：负责管理**领地**（内容分组）。解决"节点数量多"和"结构化"问题。
3.  **流转机制（Flow）**：定义内容如何在不同视图间移动，保证知识的连续性。

---

## 2. 视图架构（Sidebar控制）

侧边栏提供三个核心视图，对应三种不同的物理规则和认知模式。

### 2.1 视图定义

| 视图模式 | 对应认知模式 | 物理规则 (Physics) | 典型用途 |
| :--- | :--- | :--- | :--- |
| **1. 自由画布 (Free Canvas)** | **整理/笔记** | **绝对定位**<br>用户拖哪放哪，无引力，网格吸附 | 手动整理笔记、拼贴想法、空间记忆 |
| **2. 思考路径 (Thinking Paths)** | **回顾/反思** | **流式布局**<br>从左到右/从上到下，半自动排列 | 回顾对话过程、理解推导逻辑 |
| **3. 知识图谱 (Knowledge Graph)** | **发现/关联** | **力导向布局**<br>节点自动飘动，聚类，引力排斥 | 查看全局关系、发现隐藏关联、自动聚类 |

### 2.2 侧边栏交互

- **位置**：Canvas右侧，默认宽度280px，可折叠。
- **切换**：点击图标快速切换视图。
- **状态保持**：每个视图保持独立的状态（缩放级别、视口位置、过滤器设置）。
- **混合显示**：支持在自由画布上"叠加"显示图谱的连接线（可选）。

---

## 3. Section：通用的组织容器

Section是所有视图通用的容器组件，但在不同视图中承担不同的角色。

### 3.1 Section在各视图中的角色

1.  **在 自由画布 中**：
    *   **角色**：手动整理箱。
    *   **行为**：用户框选节点 -> 创建Section。
    *   **价值**：将相关笔记归拢，整体拖拽。

2.  **在 思考路径 中**：
    *   **角色**：对话容器。
    *   **行为**：每次深度探索对话自动生成一个Section。
    *   **价值**：区分不同话题的思考过程。

3.  **在 知识图谱 中**：
    *   **角色**：自动聚类圈。
    *   **行为**：算法根据节点紧密度或属性（如"技术栈"、"人物"）自动生成虚线框Section。
    *   **价值**：在杂乱的图谱中提供视觉引导，支持一键折叠某类节点。

### 3.2 Section通用交互

- **折叠/展开**：点击标题栏折叠，仅显示标题和节点数。**（性能优化关键）**
- **整体拖拽**：拖拽标题栏，移动整个Section及其内部所有节点。
- **右键菜单**：提升节点、归档、删除、重命名。

---

## 4. 跨视图流转机制：提升 (Promote)

为了避免视图隔离导致内容割裂，引入**"提升"**机制。

**场景**：用户在"思考路径视图"中通过对话得出了一个重要结论，或者在"知识图谱"中发现了一个关键实体。

**操作流程**：
1.  用户选中目标节点。
2.  右键 -> 选择"提升到自由画布"。
3.  **系统行为**：
    - 将该节点**复制**到自由画布视图的中心（或指定位置）。
    - 在原节点和新节点之间建立**弱引用**（Backlink）。
    - 原节点保留在原视图中（作为历史/背景）。

**价值**：让"过程"留在思考路径，让"关系"留在图谱，让"结论"沉淀到自由画布。

---

## 5. 技术可行性与性能分析

### 5.1 技术评估

基于项目当前使用的 **Konva (HTML5 Canvas)** 技术栈，该方案具备高性能可行性。

| 渲染方式 | Section带来的影响 | 性能表现 |
| :--- | :--- | :--- |
| **Konva渲染** | Section实现为 `Konva.Group`。拖拽时，只需更新Group的变换矩阵，内部节点无需独立计算。 | ✅ **高性能**，支持数千个节点流畅交互。 |

### 5.2 性能优化策略

1.  **Group变换**：利用 `Konva.Group` 实现Section，拖拽计算成本为 O(1)。
2.  **渲染剔除**：
    - **折叠状态**：Section折叠时，内部节点完全不渲染。
    - **视口剔除**：Konva自动检测并剔除视口外的Group。
3.  **布局引擎隔离**：
    - 当切换到"自由画布"时，**彻底关闭**力导向计算引擎（d3-force等），节省大量CPU资源。
    - 仅在"知识图谱"视图下启用力导向计算。

---

## 6. 实施路线图

### Phase 1: 基础架构 (MVP)
- [ ] 实现侧边栏UI，支持视图切换（数据层面先做过滤）。
- [ ] 实现基础Section组件（基于Konva Group）。
- [ ] 实现"思考路径视图"：对话自动生成节点并放入Section。

### Phase 2: 完善交互
- [ ] 实现Section的折叠/展开、整体拖拽。
- [ ] 实现"提升"机制：跨视图复制节点。
- [ ] 优化自由画布的Section操作（手动框选）。

### Phase 3: 智能增强
- [ ] **知识图谱视图**：接入力导向布局算法，实现节点自动飘动与聚类。
- [ ] 混合视图模式。
- [ ] Section的位图缓存优化。
