# Query Routing Engine å®Œæ•´æŒ‡å—

## æ¦‚è¿°

Query Routing Engine æ˜¯ä¸€ä¸ªæ™ºèƒ½æŸ¥è¯¢è·¯ç”±ç³»ç»Ÿï¼Œé€šè¿‡æ„å›¾è¯†åˆ«å°†ç”¨æˆ·æŸ¥è¯¢åˆ†å‘åˆ°æœ€é€‚åˆçš„å¤„ç†å™¨ã€‚ç³»ç»Ÿé‡‡ç”¨å¯æ’æ‹”æ¶æ„ï¼Œæ”¯æŒå¤šç§è·¯ç”±ç­–ç•¥å’Œé…ç½®åŒ–ç®¡ç†ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸš€ å¤šç­–ç•¥è·¯ç”±
- **é…ç½®åŒ–å…³é”®è¯ç­–ç•¥**: åŸºäºYAMLé…ç½®çš„é«˜æ€§èƒ½å…³é”®è¯åŒ¹é…
- **LLMæ„å›¾è¯†åˆ«ç­–ç•¥**: ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹è¿›è¡ŒåŠ¨æ€æ„å›¾åˆ†æ
- **è¯­ä¹‰ç›¸ä¼¼åº¦ç­–ç•¥**: åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰è·¯ç”±
- **æ··åˆç­–ç•¥**: å¤šç­–ç•¥åŠ æƒæŠ•ç¥¨å†³ç­–

### ğŸ”§ å¯æ’æ‹”æ¶æ„
- **ç­–ç•¥çƒ­æ’æ‹”**: è¿è¡Œæ—¶æ·»åŠ ã€ç§»é™¤è·¯ç”±ç­–ç•¥
- **å¤„ç†å™¨æ³¨å†Œ**: æ”¯æŒè‡ªå®šä¹‰æŸ¥è¯¢å¤„ç†å™¨
- **è§„åˆ™ç³»ç»Ÿ**: é«˜ä¼˜å…ˆçº§è§„åˆ™è¦†ç›–ç­–ç•¥å†³ç­–

### âš™ï¸ é…ç½®åŒ–ç®¡ç†
- **YAMLé…ç½®**: é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†å…³é”®è¯è§„åˆ™
- **çƒ­é‡è½½**: æ— éœ€é‡å¯å³å¯æ›´æ–°é…ç½®
- **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒä¸åŒè¯­è¨€çš„å…³é”®è¯åº“
- **é¢†åŸŸå®šåˆ¶**: ç‰¹å®šé¢†åŸŸçš„å…³é”®è¯å¢å¼º

## ç³»ç»Ÿæ¶æ„

```
QueryRoutingEngine
â”œâ”€â”€ è·¯ç”±ç­–ç•¥å±‚ (IRoutingStrategy)
â”‚   â”œâ”€â”€ ConfigurableKeywordStrategy
â”‚   â”œâ”€â”€ LLMIntentStrategy  
â”‚   â””â”€â”€ SemanticRoutingStrategy
â”œâ”€â”€ å¤„ç†å™¨å±‚ (IQueryHandler)
â”‚   â”œâ”€â”€ RAGQueryHandler
â”‚   â”œâ”€â”€ ChatHandler
â”‚   â”œâ”€â”€ SystemHandler
â”‚   â””â”€â”€ ToolHandler
â”œâ”€â”€ è§„åˆ™ç³»ç»Ÿ (RoutingRule)
â””â”€â”€ é…ç½®ç®¡ç† (KeywordConfigManager)
```

## å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨

```python
from modules.routing.factory import create_routing_engine

# åˆ›å»ºè·¯ç”±å¼•æ“
engine = await create_routing_engine(mode="keyword_only")

# æ‰§è¡Œè·¯ç”±å†³ç­–
result = await engine.route("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ", {})
print(f"å¤„ç†å™¨: {result.decision.handler_name}")
print(f"ç½®ä¿¡åº¦: {result.decision.confidence}")
```

### 2. é›†æˆåˆ°èŠå¤©æœåŠ¡

```python
from modules.services.enhanced_chat_service import EnhancedChatService
from modules.schemas.chat import ChatRequest

# åˆ›å»ºå¢å¼ºç‰ˆèŠå¤©æœåŠ¡
service = EnhancedChatService()
await service.initialize()
await service.initialize_routing(mode="default")

# å¤„ç†èŠå¤©è¯·æ±‚
request = ChatRequest(message="ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿ")
response = await service.chat(request)
```

### 3. é…ç½®ç®¡ç†

```python
from modules.routing import RoutingEngineFactory

# åˆ›å»ºå¸¦é…ç½®ç®¡ç†å™¨çš„å¼•æ“
engine, config_manager = await RoutingEngineFactory.create_with_config_manager()

# é‡æ–°åŠ è½½é…ç½®
await config_manager.reload_keyword_config()

# æµ‹è¯•æŸ¥è¯¢åŒ¹é…
result = await config_manager.test_query_matching("è®¡ç®—2+3")
```

## é…ç½®æ–‡ä»¶ç¤ºä¾‹

### keywords.yaml
```yaml
global_settings:
  case_sensitive: false
  enable_fuzzy_matching: true
  min_confidence: 0.3
  default_handler: "chat_handler"

routing_keywords:
  rag_handler:
    name: "RAGçŸ¥è¯†æŸ¥è¯¢"
    weight: 1.0
    patterns:
      exact_keywords: ["ä»€ä¹ˆæ˜¯", "è§£é‡Š", "ä»‹ç»"]
      prefix_keywords: ["å¦‚ä½•", "æ€ä¹ˆ", "ä¸ºä»€ä¹ˆ"]
      regex_patterns: [".*çš„å®šä¹‰$", ".*çš„æ¦‚å¿µ$"]
      
  system_handler:
    name: "ç³»ç»Ÿå‘½ä»¤"
    weight: 0.8
    patterns:
      exact_keywords: ["å¸®åŠ©", "æ¸…é™¤", "è®¾ç½®"]
      command_patterns: ["/help", "/clear", "/settings"]
```

## å¤„ç†å™¨ç±»å‹

### RAGæŸ¥è¯¢å¤„ç†å™¨ (rag_handler)
- **ç”¨é€”**: å¤„ç†éœ€è¦çŸ¥è¯†åº“æ£€ç´¢çš„æŸ¥è¯¢
- **ç‰¹æ€§**: åŸºäºè·¯ç”±ç½®ä¿¡åº¦ä¼˜åŒ–æ£€ç´¢å‚æ•°
- **ç¤ºä¾‹**: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ", "è§£é‡Šæ·±åº¦å­¦ä¹ åŸç†"

### èŠå¤©å¤„ç†å™¨ (chat_handler)  
- **ç”¨é€”**: å¤„ç†æ—¥å¸¸å¯¹è¯å’Œæƒ…æ„Ÿäº¤æµ
- **ç‰¹æ€§**: æ”¯æŒé¢„è®¾å›å¤æ¨¡æ¿å’ŒAIç”Ÿæˆå›å¤
- **ç¤ºä¾‹**: "ä½ å¥½", "æˆ‘å¾ˆå¼€å¿ƒ", "ä»Šå¤©å¤©æ°”ä¸é”™"

### ç³»ç»Ÿå¤„ç†å™¨ (system_handler)
- **ç”¨é€”**: å¤„ç†ç³»ç»Ÿå‘½ä»¤å’Œé…ç½®ç®¡ç†
- **ç‰¹æ€§**: æ”¯æŒå¯¹è¯ç®¡ç†ã€é…ç½®æŸ¥çœ‹ã€å¥åº·æ£€æŸ¥
- **ç¤ºä¾‹**: "/help", "æ¸…é™¤å†å²", "æ˜¾ç¤ºçŠ¶æ€"

### å·¥å…·å¤„ç†å™¨ (tool_handler)
- **ç”¨é€”**: å¤„ç†å·¥å…·è°ƒç”¨è¯·æ±‚
- **ç‰¹æ€§**: è®¡ç®—å™¨ã€ç¿»è¯‘ã€æé†’ç­‰å·¥å…·é›†æˆ
- **ç¤ºä¾‹**: "è®¡ç®—2+3", "ç¿»è¯‘hello", "è®¾ç½®æé†’"

## è·¯ç”±ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ç±»å‹ | å“åº”é€Ÿåº¦ | å‡†ç¡®åº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|------|---------|
| å…³é”®è¯ç­–ç•¥ | æå¿« (< 1ms) | ä¸­ç­‰ | æä½ | é«˜é¢‘æŸ¥è¯¢ã€èµ„æºå—é™ |
| LLMç­–ç•¥ | è¾ƒæ…¢ (100-500ms) | æé«˜ | è¾ƒé«˜ | å¤æ‚æ„å›¾ã€ç²¾å‡†åˆ†ç±» |
| è¯­ä¹‰ç­–ç•¥ | å¿« (10-50ms) | é«˜ | ä½ | è¯­ä¹‰ç†è§£ã€ç›¸ä¼¼æŸ¥è¯¢ |
| æ··åˆç­–ç•¥ | ä¸­ç­‰ | æé«˜ | ä¸­ç­‰ | ç”Ÿäº§ç¯å¢ƒã€å¹³è¡¡æ€§èƒ½ |

## æ€§èƒ½ä¼˜åŒ–

### 1. ç­–ç•¥é€‰æ‹©
```python
# é«˜æ€§èƒ½æ¨¡å¼ï¼šä»…å…³é”®è¯ç­–ç•¥
engine = await create_routing_engine(mode="keyword_only")

# å¹³è¡¡æ¨¡å¼ï¼šå…³é”®è¯ + è¯­ä¹‰
engine = await create_routing_engine(mode="default") 

# é«˜ç²¾åº¦æ¨¡å¼ï¼šLLMä¼˜å…ˆ
engine = await create_routing_engine(mode="llm_first")
```

### 2. é…ç½®ä¼˜åŒ–
- **åˆç†è®¾ç½®ç½®ä¿¡åº¦é˜ˆå€¼**: é¿å…è¿‡å¤šæ— æ•ˆè·¯ç”±
- **ä¼˜åŒ–å…³é”®è¯æƒé‡**: æé«˜é«˜é¢‘æ¨¡å¼çš„æƒé‡
- **å¯ç”¨æ¨¡ç³ŠåŒ¹é…**: æé«˜å®¹é”™æ€§ä½†ä¼šå¢åŠ è®¡ç®—å¼€é”€

### 3. ç¼“å­˜ç­–ç•¥
- **ç­–ç•¥ç»“æœç¼“å­˜**: ç¼“å­˜å¸¸è§æŸ¥è¯¢çš„è·¯ç”±å†³ç­–
- **é…ç½®ç¼“å­˜**: é¿å…é‡å¤åŠ è½½é…ç½®æ–‡ä»¶
- **é¢„ç¼–è¯‘æ­£åˆ™**: å¯åŠ¨æ—¶é¢„ç¼–è¯‘æ‰€æœ‰æ­£åˆ™è¡¨è¾¾å¼

## ç›‘æ§å’Œè°ƒè¯•

### 1. ç»Ÿè®¡ä¿¡æ¯
```python
# è·å–å¼•æ“ç»Ÿè®¡
stats = engine.get_stats()
print(f"æ€»è·¯ç”±æ•°: {stats['total_routes']}")
print(f"ç­–ç•¥ä½¿ç”¨åˆ†å¸ƒ: {stats['strategy_usage']}")
print(f"å¤„ç†å™¨ä½¿ç”¨åˆ†å¸ƒ: {stats['handler_usage']}")
```

### 2. å¥åº·æ£€æŸ¥
```python
# ç³»ç»Ÿå¥åº·æ£€æŸ¥
health = await engine.health_check()
print(f"å¼•æ“çŠ¶æ€: {health['engine_status']}")
```

### 3. è·¯ç”±æµ‹è¯•
```python
# æµ‹è¯•ç‰¹å®šæŸ¥è¯¢çš„è·¯ç”±
result = await config_manager.test_query_matching("æµ‹è¯•æŸ¥è¯¢")
print(f"è·¯ç”±åˆ°: {result['decision']['handler_name']}")
```

## æ‰©å±•å¼€å‘

### 1. è‡ªå®šä¹‰ç­–ç•¥
```python
from modules.routing.strategies.base import IRoutingStrategy

class CustomStrategy(IRoutingStrategy):
    async def decide_route(self, query, context):
        # è‡ªå®šä¹‰è·¯ç”±é€»è¾‘
        pass
    
    @property
    def strategy_name(self):
        return "custom_strategy"
```

### 2. è‡ªå®šä¹‰å¤„ç†å™¨
```python
from modules.routing.handlers.base import BaseQueryHandler

class CustomHandler(BaseQueryHandler):
    def __init__(self):
        super().__init__("custom_handler")
    
    async def _handle_query(self, query, context, route_metadata):
        # è‡ªå®šä¹‰å¤„ç†é€»è¾‘
        return {"content": "è‡ªå®šä¹‰å›å¤"}
```

### 3. è‡ªå®šä¹‰è§„åˆ™
```python
def custom_condition(query, context):
    return "ç‰¹æ®Šæ ‡è®°" in query

custom_rule = RoutingRule(
    name="custom_rule",
    condition=custom_condition,
    handler_name="custom_handler",
    priority=95
)
engine.add_rule(custom_rule)
```

## æœ€ä½³å®è·µ

### 1. é…ç½®ç®¡ç†
- **ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶**: å°†é…ç½®æ–‡ä»¶çº³å…¥ç‰ˆæœ¬æ§åˆ¶
- **ç¯å¢ƒéš”ç¦»**: ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶
- **æ¸è¿›å¼éƒ¨ç½²**: å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é…ç½®å˜æ›´

### 2. æ€§èƒ½ä¼˜åŒ–
- **åˆ†å±‚è·¯ç”±**: é«˜é¢‘æŸ¥è¯¢ç”¨è§„åˆ™ï¼Œå¤æ‚æŸ¥è¯¢ç”¨ç­–ç•¥
- **æ‰¹é‡å¤„ç†**: å¯¹äºæ‰¹é‡æŸ¥è¯¢è€ƒè™‘ä½¿ç”¨æ‰¹å¤„ç†æ¥å£
- **å¼‚æ­¥å¤„ç†**: åˆ©ç”¨å¼‚æ­¥ç‰¹æ€§æé«˜å¹¶å‘èƒ½åŠ›

### 3. é”™è¯¯å¤„ç†
- **ä¼˜é›…é™çº§**: ç­–ç•¥å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°å…³é”®è¯ç­–ç•¥
- **é”™è¯¯æ—¥å¿—**: è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ç”¨äºè°ƒè¯•
- **ç›‘æ§å‘Šè­¦**: è®¾ç½®å…³é”®æŒ‡æ ‡çš„ç›‘æ§å‘Šè­¦

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: è·¯ç”±ç»“æœä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ**
A: 
1. æ£€æŸ¥å…³é”®è¯é…ç½®æ˜¯å¦å®Œæ•´
2. è°ƒæ•´æƒé‡å’Œç½®ä¿¡åº¦é˜ˆå€¼
3. å¢åŠ è®­ç»ƒæ ·æœ¬ï¼ˆé’ˆå¯¹LLMç­–ç•¥ï¼‰

**Q: è·¯ç”±æ€§èƒ½è¾ƒæ…¢ï¼Ÿ**
A:
1. é€‰æ‹©æ›´è½»é‡çš„ç­–ç•¥ç»„åˆ
2. ä¼˜åŒ–é…ç½®æ–‡ä»¶ç»“æ„
3. å¯ç”¨ç»“æœç¼“å­˜

**Q: é…ç½®çƒ­é‡è½½ä¸ç”Ÿæ•ˆï¼Ÿ**
A:
1. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
2. éªŒè¯æ–‡ä»¶æƒé™
3. æŸ¥çœ‹é‡è½½æ—¥å¿—ä¿¡æ¯

## æ€»ç»“

Query Routing Engine æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æ™ºèƒ½æŸ¥è¯¢è·¯ç”±è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ï¼š

- **çµæ´»çš„æ¶æ„è®¾è®¡**: æ”¯æŒå¤šç§ç­–ç•¥å’Œå¤„ç†å™¨çš„ç»„åˆ
- **é…ç½®åŒ–ç®¡ç†**: é€šè¿‡YAMLæ–‡ä»¶å®ç°è¿ç»´å‹å¥½çš„é…ç½®ç®¡ç†
- **æ¸è¿›å¼æ¼”è¿›**: ä»å…³é”®è¯åŒ¹é…é€æ­¥å‡çº§åˆ°LLMé©±åŠ¨çš„æ™ºèƒ½è·¯ç”±
- **ç”Ÿäº§å°±ç»ª**: å®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—å’Œé”™è¯¯å¤„ç†æœºåˆ¶

ç³»ç»Ÿèƒ½å¤Ÿæ˜¾è‘—æå‡chatappçš„æ™ºèƒ½åŒ–æ°´å¹³ï¼Œå®ç°æ›´ç²¾å‡†çš„ç”¨æˆ·æ„å›¾ç†è§£å’Œæ›´é«˜æ•ˆçš„æŸ¥è¯¢å¤„ç†ã€‚