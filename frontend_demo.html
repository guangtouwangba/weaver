<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡å¤„ç†ç³»ç»Ÿæ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            color: #333;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            margin-top: 0;
            color: #666;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .task-item {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .task-id {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        
        .task-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }
        
        .task-operation {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .log-entry {
            margin-bottom: 5px;
        }
        
        .log-timestamp {
            color: #666;
        }
        
        .log-info {
            color: #007bff;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ä»»åŠ¡å¤„ç†ç³»ç»Ÿæ¼”ç¤º</h1>
            <p>æ–‡ä»¶åµŒå…¥å¤„ç†å’Œå®æ—¶çŠ¶æ€è·Ÿè¸ª</p>
        </div>

        <!-- ä»»åŠ¡æäº¤åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“¤ æäº¤ä»»åŠ¡</h2>
            <form id="taskForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="form-group">
                            <label>æ–‡ä»¶ID</label>
                            <input type="text" id="fileId" value="demo_file_123" required>
                        </div>
                        <div class="form-group">
                            <label>æ–‡ä»¶å</label>
                            <input type="text" id="fileName" value="æ¼”ç¤ºæ–‡æ¡£.pdf" required>
                        </div>
                        <div class="form-group">
                            <label>æ–‡ä»¶å¤§å° (å­—èŠ‚)</label>
                            <input type="number" id="fileSize" value="2048000" required>
                        </div>
                        <div class="form-group">
                            <label>MIMEç±»å‹</label>
                            <select id="mimeType" required>
                                <option value="application/pdf">PDFæ–‡æ¡£</option>
                                <option value="application/msword">Wordæ–‡æ¡£</option>
                                <option value="text/plain">æ–‡æœ¬æ–‡ä»¶</option>
                                <option value="image/jpeg">JPEGå›¾ç‰‡</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>ä¸»é¢˜ID</label>
                            <input type="number" id="topicId" value="42">
                        </div>
                        <div class="form-group">
                            <label>ç”¨æˆ·ID</label>
                            <input type="text" id="userId" value="demo_user">
                        </div>
                        <div class="form-group">
                            <label>ä¼˜å…ˆçº§</label>
                            <select id="priority">
                                <option value="low">ä½</option>
                                <option value="normal" selected>æ™®é€š</option>
                                <option value="high">é«˜</option>
                                <option value="urgent">ç´§æ€¥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä»»åŠ¡ç±»å‹</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" value="file_embedding" checked> æ–‡ä»¶åµŒå…¥
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" value="document_parsing"> æ–‡æ¡£è§£æ
                                </label>
                                <label style="display: flex; align-items: center;">
                                    <input type="checkbox" value="content_analysis"> å†…å®¹åˆ†æ
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn">æäº¤ä»»åŠ¡</button>
                <button type="button" class="btn btn-warning" onclick="generateRandomFile()">ç”Ÿæˆéšæœºæ–‡ä»¶</button>
            </form>
        </div>

        <!-- WebSocketè¿æ¥ -->
        <div class="section">
            <h2>ğŸ”Œ å®æ—¶è¿æ¥
                <span id="connectionStatus" class="connection-status disconnected">æœªè¿æ¥</span>
            </h2>
            <button id="connectBtn" class="btn btn-success">è¿æ¥WebSocket</button>
            <button id="disconnectBtn" class="btn btn-danger" disabled>æ–­å¼€è¿æ¥</button>
            <button class="btn" onclick="sendPing()">å‘é€Ping</button>
        </div>

        <!-- é˜Ÿåˆ—ç»Ÿè®¡ -->
        <div class="section">
            <h2>ğŸ“Š é˜Ÿåˆ—ç»Ÿè®¡</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">ç­‰å¾…ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="processingTasks">0</div>
                    <div class="stat-label">å¤„ç†ä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="failedTasks">0</div>
                    <div class="stat-label">å¤±è´¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeWorkers">0</div>
                    <div class="stat-label">æ´»è·ƒWorker</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgProcessingTime">0</div>
                    <div class="stat-label">å¹³å‡å¤„ç†æ—¶é—´(s)</div>
                </div>
            </div>
            <button class="btn" onclick="refreshStats()">åˆ·æ–°ç»Ÿè®¡</button>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="section">
            <h2>ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</h2>
            <div style="margin-bottom: 15px;">
                <button class="btn" onclick="loadTopicTasks()">åŠ è½½ä¸»é¢˜ä»»åŠ¡</button>
                <button class="btn" onclick="loadProcessingTasks()">ä»…æ˜¾ç¤ºå¤„ç†ä¸­</button>
                <button class="btn" onclick="clearTaskList()">æ¸…ç©ºåˆ—è¡¨</button>
            </div>
            <div id="taskList"></div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“ æ—¥å¿—</h2>
            <div id="logContainer" class="log"></div>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:8000';
        const WS_BASE = 'ws://localhost:8000';
        
        // WebSocketè¿æ¥
        let ws = null;
        let isConnected = false;
        
        // ä»»åŠ¡å­˜å‚¨
        let tasks = new Map();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šè¡¨å•æäº¤
            document.getElementById('taskForm').addEventListener('submit', submitTask);
            
            // ç»‘å®šWebSocketæŒ‰é’®
            document.getElementById('connectBtn').addEventListener('click', connectWebSocket);
            document.getElementById('disconnectBtn').addEventListener('click', disconnectWebSocket);
            
            // åˆå§‹åŠ è½½ç»Ÿè®¡æ•°æ®
            refreshStats();
            
            log('info', 'é¡µé¢å·²åŠ è½½');
        });
        
        // æ—¥å¿—åŠŸèƒ½
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> <span class="log-${level}">${message}</span>`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        // ä»»åŠ¡æäº¤
        async function submitTask(event) {
            event.preventDefault();
            
            const taskTypes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (taskTypes.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§ä»»åŠ¡ç±»å‹');
                return;
            }
            
            const taskData = {
                file_id: document.getElementById('fileId').value,
                file_path: `/uploads/${document.getElementById('fileName').value}`,
                file_name: document.getElementById('fileName').value,
                file_size: parseInt(document.getElementById('fileSize').value),
                mime_type: document.getElementById('mimeType').value,
                topic_id: parseInt(document.getElementById('topicId').value) || null,
                user_id: document.getElementById('userId').value,
                task_types: taskTypes,
                priority: document.getElementById('priority').value
            };
            
            try {
                log('info', 'æäº¤ä»»åŠ¡...');
                
                const response = await fetch(`${API_BASE}/api/v1/tasks/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    log('success', `ä»»åŠ¡æäº¤æˆåŠŸ: ${result.task_ids.join(', ')}`);
                    
                    // æ·»åŠ ä»»åŠ¡åˆ°æœ¬åœ°å­˜å‚¨
                    result.task_ids.forEach(taskId => {
                        tasks.set(taskId, {
                            task_id: taskId,
                            file_name: taskData.file_name,
                            status: 'pending',
                            progress: { percentage: 0, current_operation: 'ç­‰å¾…å¤„ç†' },
                            created_at: new Date().toISOString()
                        });
                    });
                    
                    updateTaskList();
                } else {
                    log('error', `ä»»åŠ¡æäº¤å¤±è´¥: ${result.message || result.detail}`);
                }
            } catch (error) {
                log('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
        
        // ç”Ÿæˆéšæœºæ–‡ä»¶æ•°æ®
        function generateRandomFile() {
            const fileNames = ['ç ”ç©¶æŠ¥å‘Š.pdf', 'ä¼šè®®çºªè¦.docx', 'é¡¹ç›®æ–‡æ¡£.pdf', 'æŠ€æœ¯è§„èŒƒ.md', 'ç”¨æˆ·æ‰‹å†Œ.pdf'];
            const mimeTypes = ['application/pdf', 'application/msword', 'text/plain'];
            
            document.getElementById('fileId').value = `file_${Date.now()}`;
            document.getElementById('fileName').value = fileNames[Math.floor(Math.random() * fileNames.length)];
            document.getElementById('fileSize').value = Math.floor(Math.random() * 5000000) + 500000;
            document.getElementById('mimeType').value = mimeTypes[Math.floor(Math.random() * mimeTypes.length)];
        }
        
        // WebSocketè¿æ¥
        function connectWebSocket() {
            const topicId = document.getElementById('topicId').value || 42;
            const clientId = `client_${Date.now()}`;
            const wsUrl = `${WS_BASE}/api/v1/tasks/ws/${topicId}/${clientId}`;
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    isConnected = true;
                    updateConnectionStatus(true);
                    log('success', `WebSocketå·²è¿æ¥: ${wsUrl}`);
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                ws.onclose = function() {
                    isConnected = false;
                    updateConnectionStatus(false);
                    log('info', 'WebSocketè¿æ¥å·²å…³é—­');
                };
                
                ws.onerror = function(error) {
                    log('error', `WebSocketé”™è¯¯: ${error}`);
                };
                
            } catch (error) {
                log('error', `è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusElement.textContent = 'å·²è¿æ¥';
                statusElement.className = 'connection-status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElement.textContent = 'æœªè¿æ¥';
                statusElement.className = 'connection-status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function sendPing() {
            if (ws && isConnected) {
                ws.send(JSON.stringify({ type: 'ping' }));
                log('info', 'å‘é€Pingæ¶ˆæ¯');
            } else {
                log('error', 'WebSocketæœªè¿æ¥');
            }
        }
        
        // WebSocketæ¶ˆæ¯å¤„ç†
        function handleWebSocketMessage(data) {
            const messageType = data.type;
            
            switch (messageType) {
                case 'task_status_update':
                    handleTaskStatusUpdate(data);
                    break;
                case 'queue_stats_update':
                    handleQueueStatsUpdate(data);
                    break;
                case 'initial_status':
                    log('info', 'æ”¶åˆ°åˆå§‹çŠ¶æ€æ•°æ®');
                    break;
                case 'pong':
                    log('info', 'æ”¶åˆ°Pongå“åº”');
                    break;
                default:
                    log('info', `æ”¶åˆ°æ¶ˆæ¯: ${messageType}`);
            }
        }
        
        function handleTaskStatusUpdate(data) {
            const taskId = data.task_id;
            const status = data.status;
            const progress = data.progress;
            
            // æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€
            if (tasks.has(taskId)) {
                const task = tasks.get(taskId);
                task.status = status;
                task.progress = progress;
                tasks.set(taskId, task);
            } else {
                // æ–°ä»»åŠ¡
                tasks.set(taskId, {
                    task_id: taskId,
                    file_name: data.file_name || 'æœªçŸ¥æ–‡ä»¶',
                    task_type: data.task_type,
                    status: status,
                    progress: progress,
                    created_at: data.timestamp
                });
            }
            
            updateTaskList();
            log('info', `ä»»åŠ¡ ${taskId}: ${status} (${progress.percentage}%)`);
        }
        
        function handleQueueStatsUpdate(data) {
            const stats = data.stats;
            updateStatsDisplay(stats);
        }
        
        // ç»Ÿè®¡æ•°æ®åˆ·æ–°
        async function refreshStats() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/tasks/queue/stats`);
                const stats = await response.json();
                updateStatsDisplay(stats);
                log('info', 'ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°');
            } catch (error) {
                log('error', `è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }
        
        function updateStatsDisplay(stats) {
            document.getElementById('pendingTasks').textContent = stats.pending_tasks || 0;
            document.getElementById('processingTasks').textContent = stats.processing_tasks || 0;
            document.getElementById('completedTasks').textContent = stats.completed_tasks || 0;
            document.getElementById('failedTasks').textContent = stats.failed_tasks || 0;
            document.getElementById('activeWorkers').textContent = stats.active_workers || 0;
            document.getElementById('avgProcessingTime').textContent = 
                (stats.average_processing_time || 0).toFixed(1);
        }
        
        // ä»»åŠ¡åˆ—è¡¨ç®¡ç†
        async function loadTopicTasks() {
            const topicId = document.getElementById('topicId').value || 42;
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/tasks/topic/${topicId}`);
                const topicTasks = await response.json();
                
                // æ›´æ–°æœ¬åœ°ä»»åŠ¡å­˜å‚¨
                topicTasks.forEach(task => {
                    tasks.set(task.task_id, task);
                });
                
                updateTaskList();
                log('info', `åŠ è½½äº†${topicTasks.length}ä¸ªä¸»é¢˜ä»»åŠ¡`);
            } catch (error) {
                log('error', `åŠ è½½ä»»åŠ¡å¤±è´¥: ${error.message}`);
            }
        }
        
        async function loadProcessingTasks() {
            const topicId = document.getElementById('topicId').value || 42;
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/tasks/topic/${topicId}?status=processing`);
                const processingTasks = await response.json();
                
                // æ¸…ç©ºå½“å‰ä»»åŠ¡ï¼Œåªæ˜¾ç¤ºå¤„ç†ä¸­çš„
                tasks.clear();
                processingTasks.forEach(task => {
                    tasks.set(task.task_id, task);
                });
                
                updateTaskList();
                log('info', `åŠ è½½äº†${processingTasks.length}ä¸ªå¤„ç†ä¸­ä»»åŠ¡`);
            } catch (error) {
                log('error', `åŠ è½½å¤„ç†ä¸­ä»»åŠ¡å¤±è´¥: ${error.message}`);
            }
        }
        
        function clearTaskList() {
            tasks.clear();
            updateTaskList();
            log('info', 'ä»»åŠ¡åˆ—è¡¨å·²æ¸…ç©º');
        }
        
        function updateTaskList() {
            const taskList = document.getElementById('taskList');
            
            if (tasks.size === 0) {
                taskList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">æš‚æ— ä»»åŠ¡</p>';
                return;
            }
            
            const sortedTasks = Array.from(tasks.values()).sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            taskList.innerHTML = sortedTasks.map(task => createTaskHTML(task)).join('');
        }
        
        function createTaskHTML(task) {
            const statusClass = `status-${task.status}`;
            const progress = task.progress || { percentage: 0, current_operation: 'æœªçŸ¥' };
            
            return `
                <div class="task-item">
                    <div class="task-header">
                        <div>
                            <strong>${task.file_name}</strong>
                            <span class="task-id">${task.task_id}</span>
                        </div>
                        <span class="task-status ${statusClass}">${getStatusText(task.status)}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress.percentage}%">
                            ${progress.percentage.toFixed(1)}%
                        </div>
                    </div>
                    <div class="task-operation">${progress.current_operation || 'ç­‰å¾…å¤„ç†'}</div>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="checkTaskStatus('${task.task_id}')">æ£€æŸ¥çŠ¶æ€</button>
                        <button class="btn btn-warning" onclick="cancelTask('${task.task_id}')">å–æ¶ˆä»»åŠ¡</button>
                    </div>
                </div>
            `;
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ',
                'retrying': 'é‡è¯•ä¸­'
            };
            return statusMap[status] || status;
        }
        
        // ä»»åŠ¡æ“ä½œ
        async function checkTaskStatus(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/v1/tasks/status/${taskId}`);
                const taskStatus = await response.json();
                
                // æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€
                tasks.set(taskId, taskStatus);
                updateTaskList();
                
                log('info', `ä»»åŠ¡ ${taskId} çŠ¶æ€: ${taskStatus.status}`);
            } catch (error) {
                log('error', `æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        }
        
        async function cancelTask(taskId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/tasks/cancel/${taskId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    log('success', `ä»»åŠ¡ ${taskId} å·²å–æ¶ˆ`);
                    await checkTaskStatus(taskId);
                } else {
                    log('error', `å–æ¶ˆä»»åŠ¡å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                log('error', `å–æ¶ˆä»»åŠ¡å¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>